<!doctype html>
<html lang="ru">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Stories Maker 9:16</title>

<style>
  :root{--bg:#0b0c10; --panel:#12141a; --text:#e9ecf2; --muted:#9aa3b2; --btn:#2a6df5;}
  body{margin:0;background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;}
  .wrap{max-width:440px;margin:18px auto;padding:16px;}
  .card{background:var(--panel);border:1px solid #232736;border-radius:16px;padding:14px}
  h2{margin:0 0 10px;font-size:18px;font-weight:800}
  textarea{width:100%;height:110px;border-radius:12px;border:1px solid #232736;background:#0f1118;color:var(--text);
    padding:12px;font-size:16px;line-height:1.35;resize:vertical}
  input[type="file"]{width:100%;margin:10px 0;color:var(--muted)}
  button{width:100%;padding:12px 14px;border-radius:12px;border:0;background:var(--btn);color:#fff;
    font-size:16px;font-weight:800;cursor:pointer}
  canvas{width:100%;border-radius:18px;margin-top:14px;background:#000}
  .small{opacity:.65;font-size:13px;margin-top:10px;text-align:center}
</style>
</head>
<body>

<div class="wrap">
  <div class="card">
    <h2>Stories Generator 9:16</h2>

    <input type="file" id="imageInput" accept="image/*">
    <textarea id="textInput" placeholder="Введите текст..."></textarea>
    <button id="btn">Создать</button>

    <canvas id="canvas" width="1080" height="1920"></canvas>
    <div class="small">Сохранение: долгий тап по картинке</div>
  </div>
</div>

<script>
const canvas = document.getElementById("canvas");
const ctx = canvas.getContext("2d", { alpha: false });
document.getElementById("btn").addEventListener("click", generate);

function wrapTextSmart(ctx, text, maxWidth) {
  const cleaned = (text || "").trim().replace(/\s+/g, " ");
  if (!cleaned) return [];

  if (ctx.measureText(cleaned).width <= maxWidth) return [cleaned];

  const words = cleaned.split(" ");
  const lines = [];
  let line = "";

  for (const w of words) {
    const test = line ? (line + " " + w) : w;
    if (ctx.measureText(test).width <= maxWidth) {
      line = test;
    } else {
      if (line) lines.push(line);
      line = w;
    }
  }
  if (line) lines.push(line);

  // rebalance: avoid last line being a single short word
  if (lines.length >= 2) {
    const last = lines[lines.length - 1];
    const prev = lines[lines.length - 2];
    const lastWords = last.split(" ");
    const prevWords = prev.split(" ");

    if (lastWords.length === 1 && prevWords.length >= 2) {
      const moved = prevWords[prevWords.length - 1];
      const newPrev = prevWords.slice(0, -1).join(" ");
      const newLast = moved + " " + last;

      if (ctx.measureText(newPrev).width <= maxWidth &&
          ctx.measureText(newLast).width <= maxWidth) {
        lines[lines.length - 2] = newPrev;
        lines[lines.length - 1] = newLast;
      }
    }
  }

  return lines;
}

function generate(){
  const file = document.getElementById("imageInput").files[0];
  const text = document.getElementById("textInput").value;
  if(!file) return;

  const reader = new FileReader();
  reader.onload = (e) => {
    const img = new Image();
    img.onload = () => {
      const W = canvas.width, H = canvas.height;

      // cover image
      ctx.clearRect(0,0,W,H);
      const scale = Math.max(W / img.width, H / img.height);
      const x = (W - img.width * scale) / 2;
      const y = (H - img.height * scale) / 2;
      ctx.drawImage(img, x, y, img.width * scale, img.height * scale);

      // soft IG-like bottom gradient
      const gradientHeight = 760;
      const g = ctx.createLinearGradient(0, H - gradientHeight, 0, H);
      g.addColorStop(0.00, "rgba(0,0,0,0.00)");
      g.addColorStop(0.55, "rgba(0,0,0,0.20)");
      g.addColorStop(1.00, "rgba(0,0,0,0.55)");
      ctx.fillStyle = g;
      ctx.fillRect(0, H - gradientHeight, W, gradientHeight);

      // IG-ish text
      const sidePadding = 84;   // почти “на всю ширину”, как в IG
      const bottomOffset = 60;  // ниже
      const maxWidth = W - sidePadding * 2;

      ctx.font = "800 70px system-ui,-apple-system,Segoe UI,Roboto,Arial";
      ctx.fillStyle = "#ffffff";
      ctx.textAlign = "left";
      ctx.textBaseline = "top";

      // subtle shadow like IG
      ctx.shadowColor = "rgba(0,0,0,0.45)";
      ctx.shadowBlur = 18;
      ctx.shadowOffsetX = 0;
      ctx.shadowOffsetY = 4;

      const lines = wrapTextSmart(ctx, text, maxWidth);
      const lineHeight = 84;
      const blockH = lines.length * lineHeight;

      const topY = H - blockH - bottomOffset;

      for(let i=0; i<lines.length; i++){
        ctx.fillText(lines[i], sidePadding, topY + i * lineHeight);
      }

      // reset shadow
      ctx.shadowColor = "transparent";
      ctx.shadowBlur = 0;
      ctx.shadowOffsetX = 0;
      ctx.shadowOffsetY = 0;
    };
    img.src = e.target.result;
  };
  reader.readAsDataURL(file);
}
</script>

</body>
</html>
